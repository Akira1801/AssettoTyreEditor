<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engine Power & Torque Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9em;
        }
        
        input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 30px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .warning {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }
        
        .data-table {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .peak {
            background: #fff3cd;
            font-weight: bold;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: block;
            margin: 0 auto;
            font-weight: 600;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèéÔ∏è Engine Power & Torque Simulator</h1>
        
        <div class="input-grid">
            <div class="input-group">
                <label>Displacement (L)</label>
                <input type="number" id="displacement" value="2.0" step="0.1" min="0.1">
            </div>
            <div class="input-group">
                <label>Peak HP</label>
                <input type="number" id="peakHP" value="300" step="10" min="50">
            </div>
            <div class="input-group">
                <label>Peak HP RPM</label>
                <input type="number" id="peakHPRPM" value="6500" step="100" min="1000">
            </div>
            <div class="input-group">
                <label>Max Boost (bar)</label>
                <input type="number" id="maxBoost" value="1.5" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label>Volumetric Efficiency (0-1.2)</label>
                <input type="number" id="VE" value="0.9" step="0.05" min="0" max="1.2">
            </div>
            <div class="input-group">
                <label>Thermal Efficiency (0-1)</label>
                <input type="number" id="thermalEff" value="0.35" step="0.01" min="0" max="1">
            </div>
            <div class="input-group">
                <label>Air-Fuel Ratio</label>
                <input type="number" id="AFR" value="14.7" step="0.1" min="10" max="20">
            </div>
            <div class="input-group">
                <label>Idle RPM</label>
                <input type="number" id="idleRPM" value="800" step="100" min="500">
            </div>
            <div class="input-group">
                <label>Redline RPM</label>
                <input type="number" id="redlineRPM" value="7500" step="100" min="2000">
            </div>
            <div class="input-group">
                <label>Ambient Pressure (bar)</label>
                <input type="number" id="ambientP" value="1.0" step="0.01" min="0.5">
            </div>
            <div class="input-group">
                <label>Intake Temperature (¬∞C)</label>
                <input type="number" id="intakeTemp" value="25" step="1" min="-20">
            </div>
        </div>
        
        <div id="warning" class="warning" style="display: none;"></div>
        
        <div class="stats" id="stats"></div>
        
        <div class="chart-container">
            <canvas id="chart"></canvas>
        </div>
        
        <div class="data-table">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>RPM</th>
                        <th>HP</th>
                        <th>Torque (Nm)</th>
                        <th>Torque (lb-ft)</th>
                        <th>BMEP (bar)</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <button class="btn" onclick="downloadLUT()">üì• Download power.lut</button>
    </div>

    <script>
        let chart;
        let engineData = [];
        
        function calculate() {
            const displacement = parseFloat(document.getElementById('displacement').value);
            const peakHP = parseFloat(document.getElementById('peakHP').value);
            const peakHPRPM = parseFloat(document.getElementById('peakHPRPM').value);
            const maxBoost = parseFloat(document.getElementById('maxBoost').value);
            const VE = parseFloat(document.getElementById('VE').value);
            const thermalEff = parseFloat(document.getElementById('thermalEff').value);
            const AFR = parseFloat(document.getElementById('AFR').value);
            const idleRPM = parseFloat(document.getElementById('idleRPM').value);
            const redlineRPM = parseFloat(document.getElementById('redlineRPM').value);
            const ambientP = parseFloat(document.getElementById('ambientP').value);
            const intakeTemp = parseFloat(document.getElementById('intakeTemp').value);
            
            const data = [];
            const rpmStep = 250;
            const boostRampRPM = idleRPM + (redlineRPM - idleRPM) * 0.75;
            
            let maxHP = 0;
            let maxHPRPM = 0;
            let maxTorque = 0;
            let maxTorqueRPM = 0;
            let maxBMEP = 0;
            
            for (let rpm = idleRPM; rpm <= redlineRPM; rpm += rpmStep) {
                // Calculate boost (linear ramp)
                let boost = 0;
                if (rpm > idleRPM) {
                    boost = Math.min(maxBoost, maxBoost * (rpm - idleRPM) / (boostRampRPM - idleRPM));
                }
                
                // Absolute pressure
                const P_abs = ambientP + boost;
                
                // Air density
                const rho = 1.225 * (P_abs / 1.0) * (293 / (intakeTemp + 273));
                
                // Airflow (kg/s)
                const m_air = (displacement * rpm / 120) * VE * rho;
                
                // Fuel flow (kg/s)
                const m_fuel = m_air / AFR;
                
                // Power (Watts) - with efficiency curve based on RPM
                const rpmRatio = rpm / peakHPRPM;
                const efficiencyCurve = Math.exp(-Math.pow((rpmRatio - 1) * 0.8, 2));
                const P = m_fuel * 43e6 * thermalEff * efficiencyCurve;
                
                // Torque (Nm)
                const T = P / (2 * Math.PI * rpm / 60);
                
                // HP
                const HP = P / 745.7;
                
                // BMEP (bar)
                const BMEP = (2 * Math.PI * T) / (displacement * 0.001 * 1e5);
                
                if (HP > maxHP) {
                    maxHP = HP;
                    maxHPRPM = rpm;
                }
                
                if (T > maxTorque) {
                    maxTorque = T;
                    maxTorqueRPM = rpm;
                }
                
                if (BMEP > maxBMEP) {
                    maxBMEP = BMEP;
                }
                
                data.push({ rpm, HP, torque: T, BMEP, isPeakHP: false, isPeakTorque: false });
            }
            
            // Mark peaks
            data.forEach(d => {
                if (d.rpm === maxHPRPM) d.isPeakHP = true;
                if (d.rpm === maxTorqueRPM) d.isPeakTorque = true;
            });
            
            // Scale to match target peak HP
            const scaleFactor = peakHP / maxHP;
            data.forEach(d => {
                d.HP *= scaleFactor;
                d.torque *= scaleFactor;
                d.BMEP *= scaleFactor;
            });
            
            maxHP = peakHP;
            maxTorque *= scaleFactor;
            maxBMEP *= scaleFactor;
            
            engineData = data;
            
            updateStats(maxHP, maxHPRPM, maxTorque, maxTorqueRPM, maxBMEP);
            updateChart(data);
            updateTable(data);
            checkBMEP(maxBMEP);
        }
        
        function updateStats(maxHP, maxHPRPM, maxTorque, maxTorqueRPM, maxBMEP) {
            const torqueLbFt = maxTorque * 0.737562;
            const html = `
                <div class="stat-box">
                    <div class="stat-value">${maxHP.toFixed(1)}</div>
                    <div class="stat-label">Peak HP @ ${maxHPRPM} RPM</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${maxTorque.toFixed(1)}</div>
                    <div class="stat-label">Peak Torque (Nm) @ ${maxTorqueRPM} RPM</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${torqueLbFt.toFixed(1)}</div>
                    <div class="stat-label">Peak Torque (lb-ft)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${maxBMEP.toFixed(2)}</div>
                    <div class="stat-label">Max BMEP (bar)</div>
                </div>
            `;
            document.getElementById('stats').innerHTML = html;
        }
        
        function updateChart(data) {
            const ctx = document.getElementById('chart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.rpm),
                    datasets: [
                        {
                            label: 'Horsepower',
                            data: data.map(d => d.HP),
                            borderColor: '#ff6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4,
                            borderWidth: 3
                        },
                        {
                            label: 'Torque (Nm)',
                            data: data.map(d => d.torque),
                            borderColor: '#36a2eb',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Engine Power & Torque Curves',
                            font: { size: 18, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'RPM',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Horsepower',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Torque (Nm)',
                                font: { size: 14, weight: 'bold' }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            data.forEach(d => {
                const row = tbody.insertRow();
                if (d.isPeakHP || d.isPeakTorque) {
                    row.className = 'peak';
                }
                
                row.insertCell(0).textContent = d.rpm;
                row.insertCell(1).textContent = d.HP.toFixed(1);
                row.insertCell(2).textContent = d.torque.toFixed(1);
                row.insertCell(3).textContent = (d.torque * 0.737562).toFixed(1);
                row.insertCell(4).textContent = d.BMEP.toFixed(2);
            });
        }
        
        function checkBMEP(maxBMEP) {
            const warning = document.getElementById('warning');
            if (maxBMEP > 18) {
                warning.style.display = 'block';
                warning.textContent = `‚ö†Ô∏è WARNING: BMEP of ${maxBMEP.toFixed(2)} bar exceeds 18 bar! This is unrealistic for street, drag, or track engines.`;
            } else {
                warning.style.display = 'none';
            }
        }
        
        function downloadLUT() {
            let content = '';
            engineData.forEach(d => {
                content += `${d.rpm}|${d.HP.toFixed(2)}\n`;
            });
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'power.lut';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Add event listeners to all inputs
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', calculate);
        });
        
        // Initial calculation
        calculate();
    </script>
</body>
</html>